name: showme
networks:
  net:
    
services:
  # Railway provides managed PostgreSQL, so we remove the local db service
  
  electric:
    image: "electricsql/electric:1.0.20"
    platform: linux/amd64
    environment:
      DATABASE_URL: ${DATABASE_URL}  # Railway provides this
      ELECTRIC_INSECURE: "true"
      ELECTRIC_USE_IPV6: "false"
    networks:
      - net
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 3
      
  postgres-bridge:
    image: postgrest/postgrest:v12.2.0
    platform: linux/amd64
    environment:
      PGRST_DB_URI: ${DATABASE_URL}
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: ${PGUSER}  # Railway provides this
      PGRST_OPENAPI_SERVER_PROXY_URI: https://${RAILWAY_PUBLIC_DOMAIN}
    depends_on:
      electric:
        condition: service_healthy
    networks:
      - net
    restart: "unless-stopped"
    
  nginx:
    image: nginx:1.29-alpine
    depends_on:
      - electric
    ports:
      - "${PORT:-3000}:80"  # Railway sets $PORT
    networks:
      - net
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    
  showme:
    build:
      context: ./client
      dockerfile: ../Dockerfile
    depends_on:
      - nginx
    environment:
      VITE_ELECTRIC_SHAPE_URL: https://${RAILWAY_PUBLIC_DOMAIN}/v1/shape
      VITE_POSTGREST_URL: https://${RAILWAY_PUBLIC_DOMAIN}
      VITE_CLOUDINARY_CLOUD_NAME: ${VITE_CLOUDINARY_CLOUD_NAME:-dmwttd5c7}
      VITE_CLOUDINARY_UPLOAD_PRESET: ${VITE_CLOUDINARY_UPLOAD_PRESET:-showme-photos}
      NODE_ENV: production
    networks:
      - net
